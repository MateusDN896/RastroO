<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RastroO — Reels</title>
  <link rel="icon" href="/public/favicon.ico" />
  <style>
    :root{
      --bg:#0b0e13; --card:#121622; --text:#e9edf1; --muted:#94a3b8;
      --chip:#1f2535; --chip-text:#dbe4ff; --brand:#5b8cff;
      --accent:#16a34a; --danger:#ef4444; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:400 15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:10px;margin:4px 0 12px}
    .back{padding:8px 12px;border-radius:10px;background:var(--card);border:1px solid #242a3a}
    .title{font-weight:700;font-size:18px}

    /* carrossel */
    .rail-wrap{position:relative}
    .rail{
      display:flex;gap:14px;overflow:auto;padding:4px 2px 12px;
      scroll-snap-type:x mandatory;scroll-behavior:smooth;
      scrollbar-width:none;
    }
    .rail::-webkit-scrollbar{display:none}

    .reel{
      flex:0 0 88vw; max-width:360px;
      scroll-snap-align:center;
      background:var(--card);border:1px solid #22293a;border-radius:16px;box-shadow:var(--shadow);
      overflow:hidden;
    }

    /* frame 9:16 */
    .frame{position:relative;width:100%;aspect-ratio:9/16;background:#0a0d14;overflow:hidden}
    .thumb{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.96)}
    .badge{
      position:absolute;left:10px;top:10px;background:#0009;color:#fff;
      padding:6px 10px;border-radius:999px;font:600 12px/1 system-ui;
      border:1px solid #ffffff22
    }

    .meta{padding:10px 12px}
    .caption{color:var(--text);font-weight:600;margin:0 0 8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      background:var(--chip);color:var(--chip-text);
      padding:8px 10px;border-radius:12px;font-weight:600;border:1px solid #2a3247
    }
    .chip .dot{width:8px;height:8px;border-radius:50%}
    .dot-views{background:#60a5fa}
    .dot-likes{background:#f472b6}
    .dot-comments{background:#facc15}
    .dot-saves{background:#34d399}

    .actions{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .open{
      padding:8px 12px;border-radius:10px;border:1px solid #2a3247;background:#111727;color:#c7d2fe;
      font-weight:700
    }
    .time{color:var(--muted);font-size:12px}

    /* setas desktop */
    .nav{
      display:none;
      position:absolute;top:50%;translate:0 -50%;
      width:44px;height:44px;border-radius:50%;border:1px solid #2a3247;background:#0e1422aa;color:#dbe4ff;
      place-content:center;cursor:pointer;backdrop-filter:blur(6px)
    }
    .nav:hover{background:#0e1422}
    .nav.prev{left:-6px} .nav.next{right:-6px}

    /* estados */
    .empty,.error,.loading{padding:24px;text-align:center;color:var(--muted)}
    .grid-skel{display:flex;gap:14px;overflow:hidden}
    .skel{flex:0 0 88vw;max-width:360px;border-radius:16px;background:linear-gradient(90deg,#111627,#141a2b,#111627);background-size:300% 100%;animation:sh 1.3s infinite}
    .skel .a{aspect-ratio:9/16;border-radius:16px 16px 0 0}
    .skel .b{height:76px}
    @keyframes sh{0%{background-position:0 0}100%{background-position:200% 0}}

    @media(min-width:820px){
      .reel{flex-basis:320px}
      .nav{display:grid}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="back" href="/public/app.html#/dashboard">← Dashboard</a>
      <div class="title">Reels &amp; Insights</div>
    </header>

    <div id="state" class="loading">
      <div class="grid-skel">
        <div class="skel"><div class="a"></div><div class="b"></div></div>
        <div class="skel"><div class="a"></div><div class="b"></div></div>
      </div>
      <div style="margin-top:10px;color:#8da2c0">Carregando Reels…</div>
    </div>

    <div class="rail-wrap" style="display:none">
      <button class="nav prev" aria-label="Anterior">◀</button>
      <div class="rail" id="rail"></div>
      <button class="nav next" aria-label="Próximo">▶</button>
    </div>
  </div>

  <script>
    const rail = document.getElementById('rail');
    const state = document.getElementById('state');
    const railWrap = document.querySelector('.rail-wrap');

    // setas (desktop)
    document.querySelector('.nav.prev').onclick = () => rail.scrollBy({left: -window.innerWidth*0.7, behavior:'smooth'});
    document.querySelector('.nav.next').onclick = () => rail.scrollBy({left:  window.innerWidth*0.7, behavior:'smooth'});

    // helper
    const n = (x) => (x ?? 0).toLocaleString('pt-BR');
    const since = (iso) => {
      if(!iso) return '';
      const d=new Date(iso), diff=(Date.now()-d.getTime())/1000;
      const m=Math.floor(diff/60), h=Math.floor(m/60), d2=Math.floor(h/24);
      if(d2>0) return d.toLocaleDateString('pt-BR');
      if(h>0) return `${h} h`;
      if(m>0) return `${m} min`;
      return `${Math.max(1,Math.floor(diff))} s`;
    };

    async function load(){
      try{
        const r = await fetch('/api/ig/reels?limit=50');
        if(!r.ok){ throw new Error(`HTTP ${r.status}`) }
        const payload = await r.json();
        const list = payload.data?.filter(m => m.media_type === 'VIDEO') ?? [];

        if(!list.length){
          state.className='empty';
          state.textContent='Sem Reels para mostrar.';
          return;
        }

        // render
        rail.innerHTML = '';
        for(const m of list){
          const el = document.createElement('article');
          el.className = 'reel';
          const thumb = m.thumbnail_url || m.media_url || '';
          const views = m.video_view_count ?? m.views ?? 0;

          el.innerHTML = `
            <div class="frame">
              <img class="thumb" loading="lazy" referrerpolicy="no-referrer" src="${thumb}" alt="Reel thumbnail" />
              <div class="badge">Reel</div>
            </div>
            <div class="meta">
              <p class="caption">${(m.caption || '').replace(/</g,'&lt;')}</p>
              <div class="chips">
                <span class="chip"><span class="dot dot-views"></span>${n(views)} views</span>
                <span class="chip"><span class="dot dot-likes"></span>${n(m.like_count)} likes</span>
                <span class="chip"><span class="dot dot-comments"></span>${n(m.comments_count)} comentários</span>
                ${m.save_count?`<span class="chip"><span class="dot dot-saves"></span>${n(m.save_count)} salvamentos</span>`:''}
              </div>
              <div class="actions">
                <a class="open" href="${m.permalink}" target="_blank" rel="noopener">Abrir no Instagram ↗</a>
                <span class="time">• ${since(m.timestamp)}</span>
              </div>
            </div>
          `;
          rail.appendChild(el);
        }

        state.style.display='none';
        railWrap.style.display='';
      }catch(err){
        console.error(err);
        state.className='error';
        state.innerHTML='Erro ao carregar Reels. <br><small style="color:#a3b1cc">'+(err.message||err)+'</small>';
      }
    }

    load();
  </script>
</body>
</html>
