<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RastroO ‚Äî Reels & Insights</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121822; --text:#e6edf3; --muted:#9fb0c0; --accent:#5eead4; --bad:#ef4444; --ok:#22c55e;
      --border:#1e293b; --link:#93c5fd; --chip:#0f172a;
    }
    .light{
      --bg:#f7fafc; --card:#ffffff; --text:#0b1220; --muted:#4a5568; --accent:#0ea5e9; --bad:#dc2626; --ok:#16a34a;
      --border:#e2e8f0; --link:#2563eb; --chip:#f1f5f9;
    }
    html,body{margin:0;height:100%}
    body{background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .btn{background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .inp{width:260px;max-width:45vw;background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px}
    .grid{display:grid;grid-template-columns:1.2fr 3fr 1.2fr 1.2fr 1.2fr 1.2fr 1.2fr 1.2fr 1.2fr;gap:10px}
    .head{background:var(--card);padding:10px;border:1px solid var(--border);border-radius:12px;display:grid;grid-template-columns:inherit;position:sticky;top:0;z-index:1}
    .row{background:var(--card);padding:10px;border:1px solid var(--border);border-radius:12px;display:grid;grid-template-columns:inherit;align-items:center}
    img.thumb{width:100%;max-width:110px;border-radius:10px;border:1px solid var(--border)}
    .cap{color:var(--muted);overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    a{color:var(--link);text-decoration:none}
    .kpi{display:flex;gap:6px;align-items:center;justify-content:flex-end}
    .muted{color:var(--muted)}
    .footer{margin-top:16px;color:var(--muted)}
    @media (max-width:1100px){
      .grid, .head, .row{grid-template-columns:1.5fr 3fr 1.3fr 1.3fr 1.3fr 1.3fr 1.3fr}
    }
    @media (max-width:780px){
      .grid, .head, .row{grid-template-columns:1.6fr 3fr 1.6fr 1.6fr 1.6fr}
      .inp{width:180px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="display:flex;gap:10px;align-items:center">
        <button id="back" class="btn">‚Üê Dashboard</button>
        <h2 style="margin:0">Reels & Insights</h2>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <input id="search" class="inp" placeholder="Buscar por legenda ou ID..."/>
        <button id="theme" class="btn">üåô/‚òÄÔ∏è</button>
        <button id="reload" class="btn">Atualizar</button>
      </div>
    </div>

    <div class="head grid muted">
      <div>Reel</div>
      <div>Legenda</div>
      <div class="kpi">Plays</div>
      <div class="kpi">Reach</div>
      <div class="kpi">Likes</div>
      <div class="kpi">Comments</div>
      <div class="kpi">Saved</div>
      <div class="kpi">Leads</div>
      <div class="kpi">Vendas</div>
    </div>
    <div id="list" style="display:flex;flex-direction:column;gap:10px"></div>

    <div class="footer">Dica: alguns insights do IG podem demorar alguns minutos para atualizar.</div>
  </div>

  <script>
    const root = document.documentElement;
    const themeBtn = document.getElementById('theme');
    function applyTheme(t){ if(t==='light'){ root.classList.add('light'); } else { root.classList.remove('light'); } localStorage.setItem('rastroo_theme', t); }
    applyTheme(localStorage.getItem('rastroo_theme') || 'dark');
    themeBtn.onclick = () => applyTheme(root.classList.contains('light') ? 'dark' : 'light');

    document.getElementById('back').onclick = ()=> location.href = '/public/dashboard.html';

    const list = document.getElementById('list');
    const search = document.getElementById('search');
    document.getElementById('reload').onclick = load;

    let DATA = [];
    search.oninput = () => render();

    function fmt(n){ return (n||0).toLocaleString('pt-BR'); }

    function row(item){
      const el = document.createElement('div');
      el.className = 'row grid';

      const reel = document.createElement('div');
      reel.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center">
          <img class="thumb" loading="lazy" src="${item.thumb || ''}" alt="">
          <div>
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <span style="opacity:.85">#${item.id}</span> <a href="${item.permalink}" target="_blank">abrir ‚Üó</a>
            </div>
            <div class="muted">${new Date(item.ts).toLocaleString('pt-BR')}</div>
          </div>
        </div>`;

      const cap = document.createElement('div'); cap.className='cap'; cap.textContent = item.caption || '‚Äî';

      const kpi = n => { const d = document.createElement('div'); d.className='kpi'; d.textContent = fmt(n); return d; };

      el.appendChild(reel);
      el.appendChild(cap);
      el.appendChild(kpi(item.insights.plays));
      el.appendChild(kpi(item.insights.reach));
      el.appendChild(kpi(item.like_count));
      el.appendChild(kpi(item.comments_count));
      el.appendChild(kpi(item.insights.saved));
      el.appendChild(kpi(item.counts.leads));
      el.appendChild(kpi(item.counts.sales));

      return el;
    }

    async function load(){
      list.innerHTML = '<div class="row" style="justify-content:center">Carregando‚Ä¶</div>';
      try{
        const r = await fetch('/api/ig/reels?limit=30');
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Falha');
        DATA = j.items || [];
        DATA.sort((a,b)=> (b.insights.plays||0) - (a.insights.plays||0));
        render();
      }catch(e){
        list.innerHTML = '<div class="row" style="justify-content:center;color:#ef4444">' + e.message + '</div>';
      }
    }

    function render(){
      const q = (search.value || '').toLowerCase().trim();
      list.innerHTML = '';
      const items = DATA.filter(it =>
        !q || (String(it.id).includes(q) || (it.caption||'').toLowerCase().includes(q))
      );
      if(!items.length){
        list.innerHTML = '<div class="row" style="justify-content:center">Nada encontrado.</div>';
        return;
      }
      for (const it of items) list.appendChild(row(it));
    }

    load();
  </script>
</body>
</html>
