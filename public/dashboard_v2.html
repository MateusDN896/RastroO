<!doctype html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>RastroO — Dashboard V3</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b0c10; --text:#111; --muted:#667085;
      --card:#ffffff; --border:#e5e7eb; --head:#f6f7fb;
      --primary:#6d5cff; --primary-contrast:#fff;
      --shadow:0 2px 14px rgba(14,22,40,.08);
      --chip:#eef2ff; --table-stripe:#fbfbfd;
      --grad:linear-gradient(135deg,#6d5cff 0%,#23a6d5 100%);
    }
    [data-theme="dark"]{
      --bg:#0b0b0f; --text:#e6e8ee; --muted:#9aa3b2;
      --card:#12131a; --border:#1f2430; --head:#0e1117;
      --primary:#8b5cf6; --primary-contrast:#0b0b0f;
      --shadow:0 2px 16px rgba(0,0,0,.35);
      --chip:#1c2231; --table-stripe:#141a25;
      --grad:linear-gradient(135deg,#8b5cf6 0%,#00bcd4 100%);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .hero{
      background:var(--grad); color:#fff;
      padding:20px 16px;
    }
    .container{max-width:1120px;margin:0 auto;padding:0 12px}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:20px;margin:0;font-weight:650;letter-spacing:.2px}
    .tag{opacity:.85;border:1px solid rgba(255,255,255,.25);padding:4px 10px;border-radius:999px;font-size:12px}
    .spacer{flex:1}
    .toggle{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid rgba(255,255,255,.25);border-radius:999px;background:transparent;color:#fff;cursor:pointer}
    .dot{width:10px;height:10px;border-radius:999px;background:#fff;opacity:.9}
    /* toolbar / cards */
    main{margin-top:-18px;padding-bottom:28px}
    .card{background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);border-radius:14px;padding:14px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input,button{font:inherit;border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px}
    .btn{cursor:pointer}
    .btn-primary{background:var(--primary);border-color:transparent;color:var(--primary-contrast)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);font-size:12px}
    .status{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    /* KPIs */
    .kpis{display:grid;gap:12px;margin-top:12px;grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){ .kpis{grid-template-columns:1fr}}
    .kpi{text-align:center;padding:18px}
    .kpi h2{margin:0;font-size:30px}
    .kpi p{margin:6px 0 0;color:var(--muted)}
    /* table */
    .table-wrap{margin-top:12px;overflow:auto;border:1px solid var(--border);border-radius:14px;background:var(--card);box-shadow:var(--shadow)}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{padding:12px 14px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
    th{background:var(--head);position:sticky;top:0;z-index:1}
    tbody tr:nth-child(even){background:var(--table-stripe)}
    /* custom period section */
    .custom{display:none;gap:8px;align-items:center}
    .custom.show{display:flex}
  </style>
</head>
<body>
  <!-- HERO -->
  <section class="hero">
    <div class="container">
      <header>
        <h1>RastroO — <strong>V3</strong></h1>
        <span id="apiBase" class="tag">API</span>
        <div class="spacer"></div>
        <button id="themeToggle" class="toggle" aria-label="Alternar tema">
          <span class="dot"></span><span id="themeLabel">Modo escuro</span>
        </button>
      </header>
    </div>
  </section>

  <main class="container">
    <!-- TOOLBAR -->
    <section class="card" style="margin-top:10px">
      <div class="toolbar">
        <!-- PERÍODO ÚNICO -->
        <label class="pill" style="background:transparent;border-color:var(--border)">
          Período&nbsp;
          <select id="period">
            <option value="today">Hoje</option>
            <option value="7d" selected>Últimos 7 dias</option>
            <option value="lastweek">Última semana (seg-dom)</option>
            <option value="30d">Últimos 30 dias</option>
            <option value="custom">Período personalizado…</option>
          </select>
        </label>

        <!-- aparece só no custom -->
        <div id="customBox" class="custom">
          <label>De: <input type="date" id="from"></label>
          <label>Até: <input type="date" id="to"></label>
          <button id="applyCustom" class="btn btn-primary">Aplicar</button>
        </div>

        <input id="filter" placeholder="Filtrar creator (@mateus)" style="min-width:220px">
        <button id="btnCsv" class="btn">Exportar CSV</button>

        <label class="pill" style="background:transparent;border-color:var(--border)">
          <input type="checkbox" id="auto" style="margin-right:6px"> Auto-refresh (30s)
        </label>

        <button id="btnAll" class="btn">Ver Tudo</button>
        <span id="status" class="right status">…</span>
      </div>
      <div id="lastFetch" class="status" style="margin-top:6px"></div>
    </section>

    <!-- KPIs -->
    <section class="kpis">
      <div class="card kpi"><h2 id="kHits">0</h2><p>Hits</p></div>
      <div class="card kpi"><h2 id="kLeads">0</h2><p>Leads</p></div>
      <div class="card kpi"><h2 id="kSales">0</h2><p>Vendas</p></div>
      <div class="card kpi"><h2 id="kRev">R$ 0,00</h2><p>Receita</p></div>
    </section>

    <!-- TABLE -->
    <section class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Creator</th><th>Hits</th><th>Leads</th><th>Vendas</th>
            <th>CR H→L</th><th>CR L→V</th><th>Receita</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="muted">Carregando…</td></tr>
        </tbody>
      </table>
    </section>

    <p id="error" class="status" style="margin-top:10px;color:#ff6b6b"></p>
  </main>

<script>
  // ================= CONFIG =================
  const API = location.origin; // mantém mesma origem do painel
  document.getElementById('apiBase').textContent = API.replace(/^https?:\/\//,'');

  // =============== THEME (toggle + memória) ===============
  const themeKey='rastroo_theme';
  const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
  const saved = localStorage.getItem(themeKey);
  function applyTheme(mode){
    document.documentElement.setAttribute('data-theme', mode);
    document.getElementById('themeLabel').textContent = (mode==='dark'?'Modo claro':'Modo escuro');
    localStorage.setItem(themeKey, mode);
  }
  applyTheme(saved || (prefersDark?'dark':'light'));
  document.getElementById('themeToggle').onclick=()=>applyTheme(
    document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'
  );

  // =============== HELPERS =================
  let lastData=null, timer=null;
  const fmtMoney=v=>(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const ymd=d=>{const z=n=>String(n).padStart(2,'0');return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate())};
  function rangeQuick(key){
    const end=new Date(), start=new Date();
    if(key==='today'){ /* hoje mesmo */ }
    else if(key==='7d'){ start.setDate(start.getDate()-6); }
    else if(key==='30d'){ start.setDate(start.getDate()-29); }
    else if(key==='lastweek'){ // semana anterior completa (seg-dom)
      const now=new Date(); const day=(now.getDay()+6)%7; // 0=seg..6=dom
      // fim da semana anterior (domingo passado)
      const endPrev=new Date(now); endPrev.setDate(now.getDate()-day-1);
      endPrev.setHours(23,59,59,999);
      // início (segunda anterior)
      const startPrev=new Date(endPrev); startPrev.setDate(endPrev.getDate()-6);
      return {from: ymd(startPrev), to: ymd(endPrev)};
    }
    return {from: ymd(start), to: ymd(end)};
  }
  function setStatus(s){ document.getElementById('status').textContent=s; }
  function setLast(u){ document.getElementById('lastFetch').textContent='Fetch: '+u; }
  function setError(m){ document.getElementById('error').textContent=m||''; }

  async function loadReport(from,to){
    const url=`${API}/api/report?from=${from}&to=${to}`;
    setStatus('Carregando…'); setLast(url); setError('');
    try{
      const r=await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j=await r.json();
      if(!j.ok) throw new Error('API ok=false');
      lastData=j; render(); setStatus('OK ✅');
    }catch(e){ setError('Falha ao carregar: '+e.message); setStatus('Erro ❌'); }
  }

  function render(){
    if(!lastData) return;
    // KPIs
    document.getElementById('kHits').textContent=lastData.summary.hits||0;
    document.getElementById('kLeads').textContent=lastData.summary.leads||0;
    document.getElementById('kSales').textContent=lastData.summary.sales||0;
    document.getElementById('kRev').textContent=fmtMoney(lastData.summary.revenue||0);
    // Tabela
    const filt=(document.getElementById('filter').value||'').trim().toLowerCase();
    const rows=(lastData.perCreator||[])
      .filter(r=>!filt||(r.creator||'').toLowerCase().includes(filt))
      .sort((a,b)=>(b.hits||0)-(a.hits||0));
    const tb=document.getElementById('tbody');
    tb.innerHTML=rows.length?'':`<tr><td colspan="7" class="muted">Sem dados para o período.</td></tr>`;
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.creator||'—'}</td>
        <td>${r.hits||0}</td>
        <td>${r.leads||0}</td>
        <td>${r.sales||0}</td>
        <td>${(r.cr_h_to_l||0)}%</td>
        <td>${(r.cr_l_to_v||0)}%</td>
        <td>${fmtMoney(r.revenue||0)}</td>`;
      tb.appendChild(tr);
    }
  }

  function exportCsv(){
    if(!lastData) return;
    const rows=[['creator','hits','leads','sales','cr_h_to_l','cr_l_to_v','revenue']];
    for(const r of (lastData.perCreator||[])){
      rows.push([r.creator||'',r.hits||0,r.leads||0,r.sales||0,(r.cr_h_to_l||0),(r.cr_l_to_v||0),(r.revenue||0)]);
    }
    const csv=rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`rastroo-${Date.now()}.csv`; a.click();
  }

  // =============== UI events ===============
  const sel=document.getElementById('period');
  const customBox=document.getElementById('customBox');
  function applySelector(){
    const v=sel.value;
    if(v==='custom'){ customBox.classList.add('show'); return; }
    customBox.classList.remove('show');
    const {from,to}=rangeQuick(v);
    loadReport(from,to);
  }
  sel.onchange=applySelector;

  document.getElementById('applyCustom').onclick=()=>{
    const f=document.getElementById('from').value;
    const t=document.getElementById('to').value;
    if(!f||!t) return setError('Defina De e Até.');
    loadReport(f,t);
  };

  document.getElementById('filter').oninput=render;
  document.getElementById('btnCsv').onclick=exportCsv;
  document.getElementById('btnAll').onclick=()=>loadReport('2000-01-01','2099-12-31');

  document.getElementById('auto').onchange=(e)=>{
    if(e.target.checked){
      if(timer) clearInterval(timer);
      timer=setInterval(()=>{
        const v=sel.value;
        if(v==='custom'){
          const f=document.getElementById('from').value;
          const t=document.getElementById('to').value;
          if(f&&t) loadReport(f,t);
        }else{
          const {from,to}=rangeQuick(v);
          loadReport(from,to);
        }
      },30000);
    }else if(timer){ clearInterval(timer); timer=null; }
  };

  // init: 7d
  (function init(){
    const {from,to}=rangeQuick('7d');
    document.getElementById('from').value=from;
    document.getElementById('to').value=to;
    applySelector();
  })();
</script>
</body>
</html>
