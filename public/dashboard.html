<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RastroO — Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0f1a;--card:#121a2b;--muted:#0c1322;--acc:#7c3aed;--text:#eaf0ff;--sub:#93a4bf;}
    *{box-sizing:border-box} body{margin:0;font-family:Montserrat,system-ui;background:var(--bg);color:var(--text);}
    header{padding:18px 16px;border-bottom:1px solid #1f2a44;background:linear-gradient(180deg,#0b0f1a,#0b0f1aee);position:sticky;top:0;z-index:5}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{font-size:22px;margin:0}
    .filters{display:flex;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap}
    input,select,button{background:var(--muted);border:1px solid #1f2a44;color:var(--text);padding:10px;border-radius:10px;outline:none}
    button{cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:20px}
    .card{background:var(--card);border:1px solid #1f2a44;padding:16px;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .card h3{margin:0 0 8px 0;font-size:14px;color:var(--sub)}
    .kpi{font-size:28px;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:12px;border-bottom:1px solid #1f2a44;font-size:14px;text-align:left}
    th{color:#a9b8d4}
    .muted{color:var(--sub)}
    .footer{opacity:.65;font-size:12px;margin-top:24px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header class="wrap">
  <h1>RastroO — Dashboard</h1>
  <div class="filters">
    <label>De <input type="date" id="from"></label>
    <label>Até <input type="date" id="to"></label>
    <select id="quick">
      <option value="">Período rápido</option>
      <option value="today">Hoje</option>
      <option value="7d">Últimos 7 dias</option>
      <option value="30d">Últimos 30 dias</option>
    </select>
    <button id="load">Carregar</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card"><h3>Hits</h3><div class="kpi" id="kpiHits">0</div></div>
    <div class="card"><h3>Leads</h3><div class="kpi" id="kpiLeads">0</div></div>
    <div class="card"><h3>Vendas</h3><div class="kpi" id="kpiSales">0</div></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>Por Creator</h3>
    <table>
      <thead>
        <tr>
          <th>Creator</th>
          <th>Hits</th>
          <th>Leads</th>
          <th>Vendas</th>
          <th>CR H→L</th>
          <th>CR L→V</th>
          <th>Receita (R$)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer muted">Cole o snippet em qualquer página: <code>&lt;script&gt;window.RASTROO_API='https://seuservidor.com';&lt;/script&gt;&lt;script src="/public/snippet.js" defer&gt;&lt;/script&gt;</code></div>
</div>

<script>
  const API = '' // mesma origem
  function sum(arr, key){ return arr.reduce((a,b)=> a + (b[key] || 0), 0) }
  function toPct(x){ return (x*100).toFixed(1)+'%' }

  function setQuick(val){
    const today = new Date();
    const pad = n => String(n).padStart(2,'0');
    const fmt = d => d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
    let from='', to='';
    if(val==='today'){
      from = fmt(today); to = fmt(today);
    } else if(val==='7d'){
      const d = new Date(today.getTime()-6*86400000);
      from = fmt(d); to = fmt(today);
    } else if(val==='30d'){
      const d = new Date(today.getTime()-29*86400000);
      from = fmt(d); to = fmt(today);
    }
    document.getElementById('from').value = from;
    document.getElementById('to').value = to;
  }

  document.getElementById('quick').addEventListener('change', e=> setQuick(e.target.value));
  document.getElementById('load').addEventListener('click', load);

  async function load(){
    const from = document.getElementById('from').value;
    const to = document.getElementById('to').value;
    const params = new URLSearchParams();
    if(from) params.set('from', from);
    if(to) params.set('to', to);
    const r = await fetch(API + '/api/report?' + params.toString());
    const j = await r.json();
    const rows = j.rows || [];
    // KPIs
    document.getElementById('kpiHits').innerText = sum(rows, 'hits');
    document.getElementById('kpiLeads').innerText = sum(rows, 'leads');
    document.getElementById('kpiSales').innerText = sum(rows, 'sales');
    // table
    const tbody = document.getElementById('tbody');
    tbody.innerHTML='';
    rows.forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.creatorSlug}</td>
        <td>${row.hits||0}</td>
        <td>${row.leads||0}</td>
        <td>${row.sales||0}</td>
        <td>${toPct(row.cr_hit_to_lead||0)}</td>
        <td>${toPct(row.cr_lead_to_sale||0)}</td>
        <td>${(row.revenue||0).toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // auto load last 7d on first paint
  setQuick('7d'); load();
</script>
</body>
</html>