<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>RastroO – Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Liberation Sans',sans-serif;padding:24px;max-width:1000px;margin:0 auto;background:#fafafa;color:#111}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    .card{background:#fff;border:1px solid #eee;padding:16px;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .stat{display:flex;gap:12px}
    .stat .kpi{flex:1;text-align:center}
    .kpi h2{margin:4px 0 2px;font-size:28px}
    .kpi p{margin:0;color:#555}
    button, select, input{font:inherit;padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #eee;text-align:left}
    th{background:#f6f6f6}
    .muted{color:#666;font-size:13px}
    .ok{color:#0a7a2a}
    .err{color:#b10000}
    .pill{display:inline-block;padding:4px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px}
    .right{margin-left:auto}
    .footer{margin-top:24px}
    .tiny{font-size:12px;color:#666}
    @media (max-width:640px){.stat{flex-direction:column}}
  </style>
</head>
<body>
  <h1>RastroO – Dashboard</h1>

  <div class="row card">
    <div class="row" style="gap:8px">
      <label>Período rápido:
        <select id="quick">
          <option value="today">Hoje</option>
          <option value="7d" selected>Últimos 7 dias</option>
          <option value="30d">Últimos 30 dias</option>
        </select>
      </label>
      <label>De: <input type="date" id="from"></label>
      <label>Até: <input type="date" id="to"></label>
      <button id="btnLoad">Carregar</button>
      <button id="btnAll">Ver Tudo (2000→2099)</button>
      <span class="right muted" id="status">…</span>
    </div>
    <div id="lastFetch" class="tiny muted"></div>
  </div>

  <div class="row stat">
    <div class="card kpi"><h2 id="kHits">0</h2><p>Hits</p></div>
    <div class="card kpi"><h2 id="kLeads">0</h2><p>Leads</p></div>
    <div class="card kpi"><h2 id="kSales">0</h2><p>Vendas</p></div>
    <div class="card kpi"><h2 id="kRev">R$ 0,00</h2><p>Receita</p></div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Creator</th>
          <th>Hits</th>
          <th>Leads</th>
          <th>Vendas</th>
          <th>CR H→L</th>
          <th>CR L→V</th>
          <th>Receita</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" class="muted">Carregue um período…</td></tr>
      </tbody>
    </table>
  </div>

  <div id="error" class="err"></div>

  <div class="footer tiny">
    <span>API: <code id="apiBase"></code></span>
    <span class="right">Dica: abra uma página com <span class="pill">?r=@teste&utm_source=@teste</span> para gravar HIT</span>
  </div>

<script>
  // >>>> Ajuste: sempre use o mesmo host do painel <<<<
  const API = location.origin; // ex.: https://trk.rastroo.site
  document.getElementById('apiBase').textContent = API;

  function fmtMoney(v){ return (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
  function ymd(d){ const z=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate()); }

  function rangeQuick(key){
    const end = new Date();
    const start = new Date();
    if(key==='today'){ /* zero horas/hoje */ }
    if(key==='7d'){ start.setDate(start.getDate()-6); }
    if(key==='30d'){ start.setDate(start.getDate()-29); }
    return { from: ymd(start), to: ymd(end) };
  }

  async function loadReport(from, to){
    const url = `${API}/api/report?from=${from}&to=${to}`;
    setStatus('Carregando…');
    setLast(url);
    setError('');
    try{
      const r = await fetch(url, { cache:'no-store' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if(!j.ok) throw new Error('API retornou ok=false');

      // KPIs
      document.getElementById('kHits').textContent  = j.summary.hits||0;
      document.getElementById('kLeads').textContent = j.summary.leads||0;
      document.getElementById('kSales').textContent = j.summary.sales||0;
      document.getElementById('kRev').textContent   = fmtMoney(j.summary.revenue||0);

      // Tabela
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      if(!j.perCreator || j.perCreator.length===0){
        tb.innerHTML = `<tr><td colspan="7" class="muted">Sem dados para o período.</td></tr>`;
      } else {
        j.perCreator.sort((a,b)=> (b.hits||0)-(a.hits||0));
        for(const r of j.perCreator){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.creator||'—'}</td>
            <td>${r.hits||0}</td>
            <td>${r.leads||0}</td>
            <td>${r.sales||0}</td>
            <td>${(r.cr_h_to_l||0)}%</td>
            <td>${(r.cr_l_to_v||0)}%</td>
            <td>${fmtMoney(r.revenue||0)}</td>`;
          tb.appendChild(tr);
        }
      }
      setStatus('OK ✅');
    }catch(e){
      setError('Falha ao carregar: '+e.message);
      setStatus('Erro ❌');
    }
  }

  function setStatus(s){ document.getElementById('status').textContent = s; }
  function setLast(u){ document.getElementById('lastFetch').textContent = 'Fetch: '+u; }
  function setError(msg){ document.getElementById('error').textContent = msg; }

  // UI handlers
  document.getElementById('btnLoad').addEventListener('click', (ev)=>{
    ev.preventDefault();
    const f = document.getElementById('from').value;
    const t = document.getElementById('to').value;
    if(!f || !t){ setError('Defina as datas "De" e "Até" ou use o seletor rápido.'); return; }
    loadReport(f, t);
  });

  document.getElementById('btnAll').addEventListener('click', ()=>{
    loadReport('2000-01-01','2099-12-31');
  });

  document.getElementById('quick').addEventListener('change', ()=>{
    const {from,to} = rangeQuick(document.getElementById('quick').value);
    document.getElementById('from').value = from;
    document.getElementById('to').value = to;
  });

  // Inicializa: coloca 7d e carrega automaticamente
  (function init(){
    const {from,to} = rangeQuick('7d');
    document.getElementById('from').value = from;
    document.getElementById('to').value = to;
    loadReport(from, to);
  })();
</script>
</body>
</html>
