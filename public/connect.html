<!doctype html>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RastroO — Conectar Instagram</title>
<style>
  :root{--bg:#0b0c10;--text:#e6edf3;--muted:#9aa3b2;--card:#111319;--border:#1f2430;--ok:#22c55e;--bad:#ef4444}
  body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:720px;margin:0 auto;padding:24px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
  .btn{background:#151a23;color:var(--text);border:1px solid var(--border);padding:10px 14px;border-radius:10px;cursor:pointer}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  .muted{color:var(--muted)}
  .ok{color:var(--ok)}
  .bad{color:var(--bad)}
</style>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h2 style="margin:0">Conectar Instagram</h2>
      <button class="btn" onclick="location.href='/public/dashboard.html'">← Dashboard</button>
    </div>

    <div class="card">
      <p class="muted">Conecte sua conta para mostrar <strong>Reels & Insights</strong> e cruzar com <strong>Leads/Vendas</strong>.</p>
      <div class="row"><button id="login" class="btn">Conectar com Instagram (Meta)</button></div>
      <div id="status" class="row muted">Checando status…</div>
      <div id="details" class="row" style="display:none"></div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const ok = qs.get('ok');
    const statusEl = document.getElementById('status');
    const detailsEl = document.getElementById('details');

    async function refresh(){
      const r = await fetch('/api/ig/creds'); const j = await r.json();
      if(!j.ok){ statusEl.innerHTML = '<span class="bad">Erro ao checar credenciais.</span>'; return; }
      if(j.connected){
        statusEl.innerHTML = '<span class="ok">Conectado</span>';
        detailsEl.style.display = 'flex';
        detailsEl.innerHTML = `
          <div class="muted">IG ID:</div><div>${j.igid}</div>
          <div class="muted" style="margin-left:16px">Usuário:</div><div>@${(j.username||'').replace(/^@/,'')}</div>
          <div class="muted" style="margin-left:16px">Token:</div><div>${j.token_preview}</div>`;
      }else{
        statusEl.innerHTML = 'Não conectado';
        detailsEl.style.display = 'none';
      }
    }

    document.getElementById('login').onclick = () => {
      location.href = '/auth/ig/login';
    };

    if(ok){ // volta do callback
      setTimeout(()=> { location.href = '/public/reels.html'; }, 600);
    }
    refresh();
  </script>
</body>
</html>
