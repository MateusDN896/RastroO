<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>RastroO — Dashboard</title>
  <link rel="icon" href="/public/favicon.ico"/>
  <style>
    :root{
      --bg:#080c12;--grad:linear-gradient(135deg,#111a2e,#0f1b33,#0b1020);
      --panel:#0d1424;--card:#0f1627;--text:#eaf0ff;--muted:#9aa8c2;
      --border:#1b2741;--brand:#60a5fa;--ok:#10b981;--warn:#f59e0b;--danger:#ef4444;
      --chip:#121a2f;--chip-text:#dbe4ff;--shadow:0 20px 60px rgba(0,0,0,.45);
    }
    [data-theme="light"]{
      --bg:#f6f8fc;--grad:linear-gradient(135deg,#eef2ff,#ffffff);
      --panel:#ffffff;--card:#ffffff;--text:#0f172a;--muted:#5b6a80;
      --border:#e6ebf4;--brand:#2563eb;--ok:#059669;--warn:#d97706;--danger:#dc2626;
      --chip:#eef2ff;--chip-text:#1e293b;--shadow:0 20px 40px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);background-image:var(--grad);background-attachment:fixed;color:var(--text);font:15px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto}
    a{color:inherit;text-decoration:none}

    .app{min-height:100vh;display:grid;grid-template-columns:260px 1fr}
    @media(max-width:960px){.app{grid-template-columns:1fr}}

    .sidebar{backdrop-filter:blur(8px);background:color-mix(in oklab, var(--panel) 88%, transparent);border-right:1px solid var(--border);padding:16px;position:sticky;top:0;height:100vh;overflow:auto}
    @media(max-width:960px){.sidebar{position:static;height:auto;display:flex;align-items:center;gap:10px}
      .sidebar nav{display:flex;gap:8px;overflow:auto}
      .sidebar nav a{white-space:nowrap}
    }
    .brand{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .brand .dot{width:12px;height:12px;border-radius:999px;background:linear-gradient(135deg,var(--brand),#8b82f6)}
    .brand b{font-size:18px}
    nav a{display:block;padding:10px 12px;border-radius:12px;border:1px solid transparent}
    nav a.active{background:var(--card);border-color:var(--border)}
    nav a + a{margin-top:8px}
    @media(max-width:960px){nav a + a{margin-top:0}}

    .main{padding:18px}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--panel);cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}

    /* HERO */
    .hero{display:grid;gap:12px;grid-template-columns:1fr; margin-bottom:14px}
    @media(min-width:960px){.hero{grid-template-columns:2fr 1fr}}
    .hero-card{background:color-mix(in oklab, var(--card) 86%, transparent);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .hero h1{margin:0 0 6px 0;font-size:18px;font-weight:700}
    .big{font-size:34px;font-weight:800;letter-spacing:0.2px}
    .muted{color:var(--muted)}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--card)}

    /* CARDS KPI */
    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:700px){.cards{grid-template-columns:repeat(3,1fr)}}
    .kpi{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    .kpi h4{margin:0 0 6px 0;font-size:13px;color:var(--muted)}
    .kpi b{font-size:22px}

    /* REELS CARROSSEL */
    .block{margin-top:18px}
    .block h3{margin:0 0 10px 0;font-size:16px}
    .rail-wrap{position:relative}
    .rail{display:flex;gap:12px;overflow:auto;padding:2px 1px 10px;scroll-snap-type:x mandatory;scroll-behavior:smooth;scrollbar-width:none}
    .rail::-webkit-scrollbar{display:none}
    .card-reel{flex:0 0 72vw;max-width:300px;scroll-snap-align:center;background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    @media(min-width:900px){.card-reel{flex-basis:260px}}
    .frame{position:relative;width:100%;aspect-ratio:9/16;background:#0a0d14;overflow:hidden}
    .thumb{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .badge{position:absolute;left:8px;top:8px;background:#000a;color:#fff;padding:5px 8px;border-radius:999px;font:700 11px/1 system-ui;border:1px solid #ffffff22}
    .meta{padding:8px 10px}
    .row{display:flex;justify-content:space-between;gap:8px}
    .chip{display:inline-flex;gap:6px;align-items:center;background:var(--chip);color:var(--chip-text);padding:6px 8px;border-radius:10px;border:1px solid var(--border);font-size:12px}
    .money{font-weight:800}
    .nav{display:none;position:absolute;top:50%;translate:0 -50%;width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:#0e1422aa;color:#dbe4ff;place-content:center;cursor:pointer;backdrop-filter:blur(6px)}
    .nav:hover{background:#0e1422}
    .nav.prev{left:-6px} .nav.next{right:-6px}
    @media(min-width:820px){.nav{display:grid}}

    /* GEOS */
    .geo{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);margin-top:14px}
    .geo-list{display:grid;gap:10px}
    .geo-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .flag{font-size:18px;margin-right:6px}
    .bar{height:10px;border-radius:999px;background:color-mix(in oklab, var(--brand) 30%, transparent)}
    .bar > i{display:block;height:10px;border-radius:999px;background:var(--brand)}
    .geo-right{display:flex;gap:8px;align-items:center}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel)}

    /* MISC */
    .topbar .btn{border-radius:12px}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand"><span class="dot"></span><b>RastroO</b></div>
      <nav id="nav">
        <a href="#/dashboard" class="active">Dashboard</a>
        <a href="#/reels">Reels & Insights</a>
        <a href="#/connect">Conectar Instagram</a>
        <a href="#/config">Configurações</a>
      </nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="group">
          <span class="tag" id="igTag">IG: verificando…</span>
        </div>
        <div class="group">
          <button class="btn" id="themeBtn">🌙/☀️ Tema</button>
          <button class="btn primary" id="connectBtn">Conectar Instagram</button>
        </div>
      </div>

      <section class="hero">
        <div class="hero-card">
          <h1>Faturamento do dia</h1>
          <div class="big" id="fatHoje">—</div>
          <div class="muted" id="vendasHoje">—</div>
        </div>
        <div class="hero-card">
          <h1>Status</h1>
          <div class="big" id="srvStatus">—</div>
          <div class="muted" id="userIg">—</div>
        </div>
      </section>

      <section class="cards" id="cardsTop">
        <!-- KPIs extras se quiser -->
      </section>

      <section class="block">
        <h3>Reels do dia (ranking por vendas)</h3>
        <div class="rail-wrap">
          <button class="nav prev" aria-label="Anterior">◀</button>
          <div class="rail" id="rail"></div>
          <button class="nav next" aria-label="Próximo">▶</button>
        </div>
        <div id="reelsEmpty" class="muted" style="padding:10px 2px;display:none">Sem Reels/vendas para hoje.</div>
      </section>

      <section class="geo" id="geoBox">
        <h3 style="margin:0 0 10px 0">Geos (hoje)</h3>
        <div class="geo-list" id="geoList">
          <div class="muted">Carregando geos…</div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // THEME
    const THEME_KEY='rastroo_theme';
    const htmlEl=document.documentElement;
    function setTheme(t){ htmlEl.setAttribute('data-theme', t); localStorage.setItem(THEME_KEY,t); }
    function initTheme(){ setTheme(localStorage.getItem(THEME_KEY) || 'dark'); }
    function toggleTheme(){ setTheme(htmlEl.getAttribute('data-theme')==='dark'?'light':'dark'); }
    document.getElementById('themeBtn').onclick = toggleTheme; initTheme();

    // NAV
    const nav = document.getElementById('nav');
    function setActive(hash){[...nav.querySelectorAll('a')].forEach(a=>a.classList.toggle('active',a.getAttribute('href')===hash));}

    // Helpers
    const BRL = new Intl.NumberFormat('pt-BR',{ style:'currency', currency:'BRL' });
    const RN = new Intl.DisplayNames(['pt-BR'], { type: 'region' });
    function startOfTodayMs(){ const n=new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate()).getTime(); }
    function num(x){ return (x ?? 0).toLocaleString('pt-BR'); }
    function flag(cc){ if(!cc||cc==='??') return '🏳️'; cc=cc.toUpperCase(); return [...cc].map(c=>String.fromCodePoint(127397 + c.charCodeAt())).join(''); }

    // UI els
    const igTag = document.getElementById('igTag');
    const connectBtn = document.getElementById('connectBtn');
    const fatHojeEl = document.getElementById('fatHoje');
    const vendasHojeEl = document.getElementById('vendasHoje');
    const srvStatusEl = document.getElementById('srvStatus');
    const userIgEl = document.getElementById('userIg');
    const rail = document.getElementById('rail');

    document.querySelector('.nav.prev').onclick = () => rail.scrollBy({left: -window.innerWidth*0.7, behavior:'smooth'});
    document.querySelector('.nav.next').onclick = () => rail.scrollBy({left:  window.innerWidth*0.7, behavior:'smooth'});

    connectBtn.onclick = ()=> location.href='/auth/ig/login';

    async function authStatus(){
      try{
        const s = await fetch('/api/auth/status').then(r=>r.json());
        igTag.textContent = s.connected ? `IG: conectado @${s.username||''}` : 'IG: não conectado';
        igTag.className = 'tag ' + (s.connected ? '' : 'muted');
        connectBtn.style.display = s.connected ? 'none' : 'inline-flex';
        userIgEl.textContent = s.connected ? '@'+(s.username||'') : 'Conecte sua conta';
        return s;
      }catch{
        igTag.textContent='IG: erro'; igTag.className='tag muted'; connectBtn.style.display='inline-flex';
        return { connected:false };
      }
    }

    async function loadHero(){
      try{
        const p = await fetch('/api/ping').then(r=>r.json());
        srvStatusEl.textContent = p.ok ? 'Online' : 'Offline';
      }catch{ srvStatusEl.textContent='Offline'; }

      const since = startOfTodayMs(), until = Date.now();
      const sales = await fetch(`/api/sales/by-reel?since=${since}&until=${until}`).then(r=>r.json()).catch(()=>({ok:false}));
      fatHojeEl.textContent = BRL.format(sales.total_revenue || 0);
      vendasHojeEl.textContent = `${num(sales.total_sales || 0)} vendas`;
    }

    async function loadReels(){
      const sales = await fetch(`/api/sales/by-reel?since=${startOfTodayMs()}&until=${Date.now()}`).then(r=>r.json()).catch(()=>({ok:false}));
      const reels = await fetch('/api/ig/reels').then(r=>r.json()).catch(()=>({ok:false}));

      if (!reels.ok || !reels.items?.length){
        document.getElementById('reelsEmpty').style.display='block';
        rail.innerHTML = '';
        return;
      }

      const byReel = sales.by_reel || {};
      const scored = reels.items.map(m=>{
        const hitId = byReel[m.id];
        const hitLink = byReel[m.permalink];
        const s = (hitId?.sales || hitLink?.sales || 0);
        const r$ = (hitId?.revenue || hitLink?.revenue || 0);
        return { m, sales: s, revenue: r$ };
      }).sort((a,b)=> b.sales - a.sales || b.revenue - a.revenue);

      if (!scored.length){ document.getElementById('reelsEmpty').style.display='block'; rail.innerHTML=''; return; }

      rail.innerHTML = scored.map((it,idx)=>{
        const m = it.m;
        const thumb = m.thumbnail_url || m.media_url || '';
        const top = it.sales>0 && idx===0;
        const badge = top ? `<span class="badge" style="background:#063;border-color:#0a4">+ vendido</span>` : `<span class="badge">Reel</span>`;
        return `
          <a class="card-reel" href="${m.permalink}" target="_blank" rel="noopener">
            <div class="frame">
              <img class="thumb" loading="lazy" referrerpolicy="no-referrer" src="${thumb}" alt="Reel"/>
              ${badge}
            </div>
            <div class="meta">
              <div class="row">
                <span class="chip">Vendas: <b>${num(it.sales)}</b></span>
                <span class="chip money">${BRL.format(it.revenue || 0)}</span>
              </div>
            </div>
          </a>
        `;
      }).join('');
      document.getElementById('reelsEmpty').style.display='none';
    }

    async function loadGeos(){
      const since = startOfTodayMs(), until = Date.now();
      const j = await fetch(`/api/geo/summary?since=${since}&until=${until}`).then(r=>r.json()).catch(()=>({ok:false}));
      const box = document.getElementById('geoList');
      if (!j.ok){ box.innerHTML = `<div class="muted">Erro ao carregar geos.</div>`; return; }
      if (!j.countries?.length){ box.innerHTML = `<div class="muted">Sem geos para hoje.</div>`; return; }

      const total = Math.max(1, j.total_leads + j.total_sales);
      const top = j.countries.slice(0, 6);
      box.innerHTML = top.map(c=>{
        const totalC = c.leads + c.sales;
        const pct = Math.round((totalC/total)*100);
        const name = (c.code && c.code!=="??") ? (RN.of(c.code) || c.code) : 'Desconhecido';
        return `
          <div class="geo-item">
            <div>
              <div class="muted" style="margin-bottom:6px"><span class="flag">${flag(c.code)}</span> ${name}</div>
              <div class="bar"><i style="width:${Math.min(100,pct)}%"></i></div>
            </div>
            <div class="geo-right">
              <span class="pill">Leads: <b>${num(c.leads)}</b></span>
              <span class="pill">Vendas: <b>${num(c.sales)}</b></span>
            </div>
          </div>
        `;
      }).join('');
    }

    async function pageDashboard(){
      setActive('#/dashboard');
      await authStatus();
      await loadHero();
      await loadReels();
      await loadGeos();
    }
    async function pageReels(){
      setActive('#/reels');
      document.querySelector('.hero').style.display='none';
      document.getElementById('geoBox').style.display='none';
      document.getElementById('cardsTop').style.display='none';
      // direciona para carrossel do dashboard (ficou melhor integrado)
      location.hash = '#/dashboard';
    }
    async function pageConnect(){
      setActive('#/connect');
      const s = await authStatus();
      alert(s.connected ? 'Conta já conectada.' : 'Clique em "Conectar Instagram".');
      if (!s.connected) connectBtn.focus();
      location.hash = '#/dashboard';
    }
    async function pageConfig(){
      setActive('#/config');
      toggleTheme();
      location.hash = '#/dashboard';
    }

    async function router(){
      const h = (location.hash || '#/dashboard');
      if (h.startsWith('#/reels')) return pageReels();
      if (h.startsWith('#/connect')) return pageConnect();
      if (h.startsWith('#/config')) return pageConfig();
      document.querySelector('.hero').style.display='';
      document.getElementById('geoBox').style.display='';
      document.getElementById('cardsTop').style.display='';
      return pageDashboard();
    }
    window.addEventListener('hashchange', router);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) router(); });
    router();
  </script>
</body>
</html>
