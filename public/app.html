<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>RastroO ‚Äî Dashboard</title>
  <link rel="icon" href="/public/favicon.ico"/>
  <style>
    :root{
      --bg:#070b12;--grad:linear-gradient(180deg,#0a0f1a 0%,#080c12 100%);
      --panel:#0f1a2eec;--card:#0f1627;--text:#eaf0ff;--muted:#9aa8c2;--border:#1b2741;
      --brand:#7c8cff;--brand2:#60a5fa;--ok:#10b981;--warn:#f59e0b;--danger:#ef4444;
      --chip:#121a2f;--chip-text:#dbe4ff;--shadow:0 18px 60px rgba(0,0,0,.45);
    }
    [data-theme="light"]{
      --bg:#f6f8fc;--grad:linear-gradient(180deg,#f6f8ff 0%,#ffffff 100%);
      --panel:#ffffffee;--card:#ffffff;--text:#0f172a;--muted:#5b6a80;--border:#e6ebf4;
      --brand:#3b82f6;--brand2:#2563eb;--chip:#eef2ff;--chip-text:#1e293b;--shadow:0 18px 40px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;color:var(--text);background:var(--bg);background-image:var(--grad);font:15px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto}
    a{color:inherit;text-decoration:none}
    .app{min-height:100vh;display:grid;grid-template-columns:280px 1fr}
    @media(max-width:980px){.app{grid-template-columns:1fr}}
    .sidebar{backdrop-filter:blur(10px);background:var(--panel);border-right:1px solid var(--border);padding:16px;position:sticky;top:0;height:100vh;overflow:auto}
    @media(max-width:980px){.sidebar{position:static;height:auto;padding:10px 16px}}
    .brand{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .brand .logo{width:28px;height:28px;border-radius:10px;background:conic-gradient(from 210deg at 50% 50%, var(--brand), var(--brand2)); box-shadow:0 4px 18px color-mix(in oklab, var(--brand) 30%, transparent)}
    .brand b{font-size:18px;letter-spacing:.3px}
    nav{display:flex;flex-direction:column;gap:8px}
    nav a{padding:10px 12px;border-radius:12px;border:1px solid transparent}
    nav a.active{background:var(--card);border-color:var(--border)}
    @media(max-width:980px){nav{flex-direction:row;overflow:auto} nav a{white-space:nowrap}}
    .main{padding:18px}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--panel);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:transparent;color:#fff}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--card)}
    .muted{color:var(--muted)}
    .card{background:color-mix(in oklab, var(--card) 86%, transparent);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}

    /* Carrossel Reels */
    .block{margin-top:18px}
    .rail-wrap{position:relative}
    .rail{display:flex;gap:12px;overflow:auto;padding:2px 1px 10px;scroll-snap-type:x mandatory;scroll-behavior:smooth;scrollbar-width:none}
    .rail::-webkit-scrollbar{display:none}
    .reel{flex:0 0 72vw;max-width:300px;scroll-snap-align:center;background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    @media(min-width:900px){.reel{flex-basis:260px}}
    .frame{position:relative;width:100%;aspect-ratio:9/16;background:#0a0d14;overflow:hidden}
    .thumb{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .badge{position:absolute;left:8px;top:8px;background:#000a;color:#fff;padding:5px 8px;border-radius:999px;font:700 11px/1 system-ui;border:1px solid #ffffff22}
    .meta{padding:8px 10px}
    .row{display:flex;justify-content:space-between;gap:8px}
    .chip{display:inline-flex;gap:6px;align-items:center;background:var(--chip);color:var(--chip-text);padding:6px 8px;border-radius:10px;border:1px solid var(--border);font-size:12px}
    .money{font-weight:800}
    .nav{display:none;position:absolute;top:50%;translate:0 -50%;width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:#0e1422aa;color:#dbe4ff;place-content:center;cursor:pointer;backdrop-filter:blur(6px)}
    .nav.prev{left:-6px} .nav.next{right:-6px}
    @media(min-width:820px){.nav{display:grid}}
    .alert{padding:10px 12px;border-radius:12px;border:1px solid;color:#fff;margin-bottom:10px}
    .alert.err{background:#2a0d14;border-color:#5b1e27}
    .pre{white-space:pre-wrap;background:#0b1222;border:1px solid #1f2b44;padding:10px;border-radius:10px;max-height:240px;overflow:auto;font:12px/1.4 ui-monospace, SFMono-Regular, Menlo}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand"><div class="logo"></div><b>RastroO</b></div>
      <nav id="nav">
        <a href="#/dashboard" class="active">Dashboard</a>
        <a href="#/connect">Conectar Instagram</a>
        <a href="#/config">Tema</a>
      </nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="group">
          <span class="tag" id="igTag">IG: verificando‚Ä¶</span>
        </div>
        <div class="group">
          <button class="btn" id="themeBtn">üåô/‚òÄÔ∏è Tema</button>
          <button class="btn primary" id="connectBtn">Conectar Instagram</button>
        </div>
      </div>

      <div id="view"></div>
    </main>
  </div>

  <script>
    // ===== THEME
    const THEME_KEY='rastroo_theme';
    const htmlEl=document.documentElement;
    function setTheme(t){ htmlEl.setAttribute('data-theme', t); localStorage.setItem(THEME_KEY,t); }
    function initTheme(){ setTheme(localStorage.getItem(THEME_KEY) || 'dark'); }
    function toggleTheme(){ setTheme(htmlEl.getAttribute('data-theme')==='dark'?'light':'dark'); }
    document.getElementById('themeBtn').onclick = toggleTheme; initTheme();

    // ===== HELPERS
    const BRL = new Intl.NumberFormat('pt-BR',{ style:'currency', currency:'BRL' });
    function num(x){ return (x ?? 0).toLocaleString('pt-BR'); }

    // Parse do hash: "#/connect?error=..."
    function parseHash(){
      const raw = (location.hash || '#/dashboard').slice(1); // "/connect?error=..."
      const qpos = raw.indexOf('?');
      const path = qpos>=0 ? raw.slice(0,qpos) : raw;
      const qs   = qpos>=0 ? raw.slice(qpos+1) : '';
      const params = new URLSearchParams(qs);
      return { path, params };
    }

    // ===== STATUS IG
    const igTag = document.getElementById('igTag');
    const connectBtn = document.getElementById('connectBtn');
    connectBtn.onclick = ()=> location.href='/auth/ig/login';
    async function authStatus(){
      try{
        const s = await fetch('/api/auth/status').then(r=>r.json());
        igTag.textContent = s.connected ? `IG: @${s.username||''}` : 'IG: n√£o conectado';
        igTag.className = 'tag ' + (s.connected ? '' : 'muted');
        connectBtn.style.display = s.connected ? 'none' : 'inline-flex';
        return s;
      }catch{
        igTag.textContent='IG: erro'; igTag.className='tag muted'; connectBtn.style.display='inline-flex';
        return { connected:false };
      }
    }

    // ===== VIEWS
    const view = document.getElementById('view');

    function errorHuman(code){
      const map = {
        token_exchange: 'Erro ao trocar o c√≥digo por token (confira IG_REDIRECT no Render e em Valid OAuth Redirect).',
        codigo_ou_state_ausente: 'State inv√°lido/ausente. Inicie o login e finalize sem trocar de dom√≠nio.',
        no_ig_business_linked: 'N√£o foi achado um Instagram Business/Creator ligado a uma P√°gina que voc√™ administra.',
        callback_exception: 'Erro inesperado no callback. Tente novamente.',
      };
      return map[code] || code;
    }

    function skeletonDash(){
      return `
        <section class="card" style="margin-bottom:14px">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
            <div><b>Faturamento do dia</b><div class="muted">Carregando‚Ä¶</div></div>
            <div class="tag">Status: <span id="srvTag">‚Ä¶</span></div>
          </div>
        </section>
        <section class="block">
          <h3>Reels do dia</h3>
          <div class="rail-wrap">
            <button class="nav prev">‚óÄ</button>
            <div class="rail" id="rail"></div>
            <button class="nav next">‚ñ∂</button>
          </div>
          <div class="muted" id="reelsEmpty" style="padding:10px 2px;display:none">Sem Reels/vendas.</div>
        </section>
        <section class="card" style="margin-top:14px">
          <b>Geos do dia</b>
          <div class="muted">Carregando‚Ä¶</div>
        </section>
      `;
    }

    async function pageDashboard(){
      const { params } = parseHash();
      const err = params.get('error'); // se voltar do OAuth direto pro dashboard
      view.innerHTML = (err ? `<div class="alert err">[OAuth] ${errorHuman(err)}</div>` : '') + skeletonDash();

      // status
      try { const p = await fetch('/api/ping').then(r=>r.json()); document.getElementById('srvTag').textContent = p.ok?'Online':'Offline'; } catch { document.getElementById('srvTag').textContent='Offline'; }

      // vendas/receita hoje
      const startOfToday = new Date(new Date().toDateString()).getTime();
      const sales = await fetch(`/api/sales/by-reel?since=${startOfToday}&until=${Date.now()+1}`).then(r=>r.json()).catch(()=>({ok:false}));
      // reels
      const reels = await fetch('/api/ig/reels').then(r=>r.json()).catch(()=>({ok:false}));
      const rail = document.getElementById('rail');
      document.querySelector('.nav.prev').onclick = () => rail.scrollBy({left: -window.innerWidth*0.7, behavior:'smooth'});
      document.querySelector('.nav.next').onclick = () => rail.scrollBy({left:  window.innerWidth*0.7, behavior:'smooth'});

      if (!reels.ok || !reels.items?.length){ document.getElementById('reelsEmpty').style.display='block'; return; }
      const byReel = sales.by_reel || {};
      const scored = reels.items.map(m=>{
        const idHit  = byReel[m.id];
        const urlHit = byReel[m.permalink];
        const s = (idHit?.sales || urlHit?.sales || 0);
        const r$ = (idHit?.revenue || urlHit?.revenue || 0);
        return { m, sales:s, revenue:r$ };
      }).sort((a,b)=> b.sales - a.sales || b.revenue - a.revenue);
      rail.innerHTML = scored.map((it,idx)=>{
        const m = it.m, top = it.sales>0 && idx===0;
        const badge = top ? `<span class="badge" style="background:#063;border-color:#0a4">+ vendido</span>` : `<span class="badge">Reel</span>`;
        const thumb = m.thumbnail_url || m.media_url || '';
        return `
          <a class="reel" href="${m.permalink}" target="_blank" rel="noopener">
            <div class="frame"><img class="thumb" loading="lazy" referrerpolicy="no-referrer" src="${thumb}" alt="Reel"/>${badge}</div>
            <div class="meta"><div class="row"><span class="chip">Vendas: <b>${num(it.sales)}</b></span><span class="chip money">${BRL.format(it.revenue||0)}</span></div></div>
          </a>
        `;
      }).join('');
    }

    async function pageConnect(){
      const { params } = parseHash();
      const err = params.get('error');
      const st = await authStatus();

      view.innerHTML = `
        ${err ? `<div class="alert err">[OAuth] ${errorHuman(err)}</div>` : ''}
        <section class="card" style="margin-bottom:14px">
          <h3 style="margin:0 0 10px 0">Conectar Instagram</h3>
          <div class="muted" style="margin-bottom:10px">
            Use este bot√£o para iniciar o login pelo Facebook. N√£o troque de dom√≠nio no meio.
          </div>
          ${st.connected
            ? `<div class="tag">Conectado como <b>@${st.username||''}</b></div>`
            : `<button class="btn primary" id="btnLogin">Conectar Instagram</button>`
          }
        </section>

        <section class="card">
          <h3 style="margin:0 0 10px 0">Debug r√°pido</h3>
          <div class="group" style="margin-bottom:10px;flex-wrap:wrap">
            <button class="btn" id="bStatus">Ver /api/auth/status</button>
            <button class="btn" id="bPages">Ver /api/debug/fb/pages</button>
            <button class="btn" id="bReset">Resetar conex√£o</button>
          </div>
          <pre class="pre" id="out">Clique em um dos bot√µes acima‚Ä¶</pre>
        </section>
      `;

      const out = document.getElementById('out');
      const setOut = (obj)=> out.textContent = (typeof obj==='string')? obj : JSON.stringify(obj, null, 2);

      const btnLogin = document.getElementById('btnLogin');
      if (btnLogin) btnLogin.onclick = ()=> location.href='/auth/ig/login';

      document.getElementById('bStatus').onclick = async ()=>{
        try { setOut(await fetch('/api/auth/status').then(r=>r.json())); } catch(e){ setOut(String(e)); }
      };
      document.getElementById('bPages').onclick = async ()=>{
        try { setOut(await fetch('/api/debug/fb/pages').then(r=>r.json())); } catch(e){ setOut(String(e)); }
      };
      document.getElementById('bReset').onclick = async ()=>{
        try { setOut(await fetch('/api/debug/auth/reset').then(r=>r.json())); } catch(e){ setOut(String(e)); }
        // depois do reset, mostre bot√£o de login
        location.hash = '#/connect';
      };
    }

    async function pageConfig(){ toggleTheme(); location.hash='#/dashboard'; }

    // ===== ROUTER
    const nav = document.getElementById('nav');
    function setActive(hash){[...nav.querySelectorAll('a')].forEach(a=>a.classList.toggle('active',a.getAttribute('href')===hash));}
    async function router(){
      const { path } = parseHash();
      setActive('#'+path);
      await authStatus();
      if (path==='/connect') return pageConnect();
      if (path==='/config')  return pageConfig();
      return pageDashboard();
    }
    window.addEventListener('hashchange', router);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) router(); });
    router();
  </script>
</body>
</html>
