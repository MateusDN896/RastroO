<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RastroO ‚Äî Dashboard</title>
<style>
  :root { --bg:#0b1220; --panel:#0e1730; --text:#eaf0ff; --muted:#9bb0d0; --border:#1b2b4a; --accent:#3b82f6; }
  [data-theme="light"] { --bg:#fbfbfd; --panel:#ffffff; --text:#0c1323; --muted:#4a5568; --border:#e6e9f2; --accent:#2563eb; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto}
  .app{display:grid;grid-template-columns:260px 1fr;min-height:100dvh}
  @media(max-width:980px){.app{grid-template-columns:1fr}}
  .side{border-right:1px solid var(--border);background:var(--panel)}
  .brand{padding:18px 16px;border-bottom:1px solid var(--border);font-weight:800}
  .nav a{display:block;padding:12px 16px;color:var(--text);text-decoration:none;border-bottom:1px solid var(--border)}
  .nav a:hover{background:rgba(255,255,255,.04)}
  .top{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--panel);z-index:10}
  .btn{appearance:none;border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.ghost{background:transparent}
  .grid{display:grid;gap:12px;padding:12px;grid-template-columns:repeat(12,1fr)}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
  .kpi{grid-column:span 12}
  .kpi .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media(min-width:720px){.kpi{grid-column:span 12}.kpi .row{grid-template-columns:repeat(6,1fr)}}
  .kpi .mini{background:rgba(255,255,255,.03);border:1px dashed var(--border);border-radius:12px;padding:12px}
  .muted{color:var(--muted);font-size:12px}
  .title{font-weight:800;margin:0 0 6px}
  .rowbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  select, input{border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:10px;padding:8px 10px}
  /* Carrossel */
  .carousel{overflow-x:auto;display:flex;gap:12px;scroll-snap-type:x mandatory;padding-bottom:4px}
  .reel{min-width:220px;max-width:220px;scroll-snap-align:start;background:var(--panel);border:1px solid var(--border);border-radius:14px}
  .thumb{aspect-ratio:9/16;width:100%;object-fit:cover;border-radius:12px 12px 0 0;background:#000}
  .meta{padding:8px 10px}
  .meta .caps{font-size:11px;color:var(--muted)}
  .badge{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);margin-right:6px}
  .ok{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.35)}
  .warn{background:rgba(234,179,8,.1);border-color:rgba(234,179,8,.35)}
  .err{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.35)}
  /* footer fixo mobile */
  .dock{position:sticky;bottom:0;background:var(--panel);border-top:1px solid var(--border);padding:8px 12px;display:flex;gap:8px}
  .hide{display:none}
</style>
</head>
<body>
<div class="app" id="app">
  <aside class="side">
    <div class="brand">üåÄ RastroO</div>
    <nav class="nav">
      <a href="#/dashboard">üìä Dashboard</a>
      <a href="#/reels">üéûÔ∏è Reels</a>
      <a href="#/config">‚öôÔ∏è Configura√ß√µes</a>
    </nav>
  </aside>

  <main>
    <div class="top">
      <div class="rowbar">
        <button class="btn" id="theme">üåì Tema</button>
        <span id="igStatus" class="badge">IG: checando‚Ä¶</span>
      </div>
      <div class="rowbar">
        <select id="periodo">
          <option value="today">Hoje</option>
          <option value="7">√öltimos 7 dias</option>
          <option value="15">√öltimos 15 dias</option>
          <option value="30" selected>√öltimos 30 dias</option>
          <option value="custom">Per√≠odo personalizado‚Ä¶</option>
        </select>
        <input id="from" type="date" class="hide"/>
        <input id="to" type="date" class="hide"/>
        <button class="btn" id="apply">Aplicar</button>
        <button class="btn" id="reload">Recarregar</button>
        <button class="btn primary" id="wizard">Assistente</button>
      </div>
    </div>

    <div class="grid">
      <!-- KPIs (mostro se /api/stats existir; se n√£o, escondo) -->
      <section class="card kpi" id="kpi">
        <p class="title">Resumo</p>
        <div class="row">
          <div class="mini"><div class="muted">Leads</div><div id="kpiLeads" style="font-weight:800;font-size:20px">‚Äî</div></div>
          <div class="mini"><div class="muted">Vendas</div><div id="kpiSales" style="font-weight:800;font-size:20px">‚Äî</div></div>
          <div class="mini"><div class="muted">Faturamento</div><div id="kpiRev" style="font-weight:800;font-size:20px">‚Äî</div></div>
          <div class="mini"><div class="muted">Convers√£o</div><div id="kpiConv" style="font-weight:800;font-size:20px">‚Äî</div></div>
          <div class="mini"><div class="muted">CTR</div><div id="kpiCtr" style="font-weight:800;font-size:20px">‚Äî</div></div>
          <div class="mini"><div class="muted">Retorno</div><div id="kpiRoi" style="font-weight:800;font-size:20px">‚Äî</div></div>
        </div>
      </section>

      <!-- Reels -->
      <section class="card" style="grid-column:span 12">
        <div class="rowbar" style="justify-content:space-between;align-items:center;margin-bottom:8px">
          <p class="title" style="margin:0">Reels do per√≠odo</p>
          <div>
            <button class="btn" id="manualImport">Importar manual</button>
          </div>
        </div>
        <div id="reelsWrap">
          <div class="carousel" id="reels"></div>
          <p id="reelsEmpty" class="muted" style="margin-top:6px">Carregando Reels‚Ä¶</p>
        </div>
      </section>
    </div>

    <div class="dock">
      <button class="btn" id="btnDash">Dashboard</button>
      <button class="btn" id="btnReels">Reels</button>
      <button class="btn primary" id="btnConnect">Conectar IG</button>
    </div>
  </main>
</div>

<script>
(function(){
  // Tema
  const root = document.documentElement;
  const themeBtn = document.getElementById('theme');
  function applyTheme(t){ root.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
  applyTheme(localStorage.getItem('theme') || 'dark');
  themeBtn.onclick = ()=> applyTheme(root.getAttribute('data-theme')==='dark'?'light':'dark');

  // Navega√ß√£o simples
  document.getElementById('wizard').onclick = ()=> window.open('/api/debug/wizard', '_blank');
  document.getElementById('btnConnect').onclick = ()=> window.open('/api/debug/wizard', '_blank');
  document.getElementById('reload').onclick = ()=> { loadAuth(); loadReels(); loadStats(); };
  document.getElementById('btnDash').onclick = ()=> location.hash = '#/dashboard';
  document.getElementById('btnReels').onclick = ()=> location.hash = '#/reels';

  // Per√≠odo
  const sel = document.getElementById('periodo'), from = document.getElementById('from'), to = document.getElementById('to');
  const apply = document.getElementById('apply');
  sel.onchange = ()=>{
    const v = sel.value;
    if (v==='custom'){ from.classList.remove('hide'); to.classList.remove('hide'); }
    else { from.classList.add('hide'); to.classList.add('hide'); }
  };
  apply.onclick = ()=> { loadReels(); loadStats(); };

  // Status IG
  async function loadAuth(){
    try{
      const r = await fetch('/api/auth/status'); const j = await r.json();
      const el = document.getElementById('igStatus');
      if (j.connected){
        el.textContent = `IG: @${j.username||'conectado'}`;
        el.className = 'badge ok';
      } else {
        el.textContent = 'IG: n√£o conectado';
        el.className = 'badge err';
      }
    }catch(e){
      const el = document.getElementById('igStatus');
      el.textContent = 'IG: erro';
      el.className = 'badge err';
    }
  }

  // Reels
  function periodParams(){
    const v = sel.value;
    if (v==='today' || v==='7' || v==='15' || v==='30') return {};
    if (v==='custom' && from.value && to.value) return {from: from.value, to: to.value};
    return {};
  }

  function renderReels(items){
    const wrap = document.getElementById('reels');
    const empty = document.getElementById('reelsEmpty');
    wrap.innerHTML = '';
    if (!items || !items.length){
      empty.textContent = 'Sem Reels para mostrar.';
      return;
    }
    empty.textContent = '';
    for (const m of items){
      const card = document.createElement('div');
      card.className = 'reel';
      const img = document.createElement('img');
      img.className = 'thumb';
      img.src = m.thumbnail_url || m.media_url || '';
      img.alt = m.caption||'';
      img.loading = 'lazy';
      card.appendChild(img);
      const meta = document.createElement('div'); meta.className='meta';
      const cap = document.createElement('div'); cap.className='caps'; cap.textContent = (m.caption||'').slice(0,80);
      const nums = document.createElement('div'); nums.style.display='flex'; nums.style.gap='8px'; nums.style.flexWrap='wrap';
      const b1 = `<span class="badge">‚ñ∂ ${m.video_play_count??'‚Äî'}</span>`;
      const b2 = `<span class="badge">‚ù§ ${m.like_count??'‚Äî'}</span>`;
      const b3 = `<span class="badge">üí¨ ${m.comments_count??'‚Äî'}</span>`;
      nums.innerHTML = b1 + b2 + b3;
      const link = document.createElement('a'); link.href = m.permalink; link.target='_blank'; link.textContent = 'Abrir no Instagram';
      link.style.display='inline-block'; link.style.marginTop='6px'; link.style.color='var(--accent)';
      meta.appendChild(cap); meta.appendChild(nums); meta.appendChild(link);
      card.appendChild(meta);
      wrap.appendChild(card);
    }
  }

  async function loadReels(){
    const empty = document.getElementById('reelsEmpty');
    empty.textContent = 'Carregando Reels‚Ä¶';
    try{
      const r = await fetch('/api/ig/reels'); const j = await r.json();
      if (j && j.ok && Array.isArray(j.items) && j.items.length){
        renderReels(j.items);
        localStorage.removeItem('reels_manual'); // preferir dados oficiais
      } else {
        // fallback manual
        const manual = localStorage.getItem('reels_manual');
        if (manual){
          try { renderReels(JSON.parse(manual)); empty.textContent = '(dados manuais)'; }
          catch { empty.textContent = 'Sem Reels para mostrar.'; }
        } else {
          empty.textContent = 'Sem Reels para mostrar.';
        }
      }
    }catch(e){
      const manual = localStorage.getItem('reels_manual');
      if (manual){ renderReels(JSON.parse(manual)); empty.textContent='(dados manuais)'; }
      else { empty.textContent = 'Erro ao carregar Reels.'; }
    }
  }

  // Import manual (cola JSON de reels se IG n√£o conectar a tempo)
  document.getElementById('manualImport').onclick = ()=>{
    const txt = prompt('Cole aqui um JSON com uma lista de reels (campos: thumbnail_url, media_url, caption, permalink, comments_count, like_count, video_play_count)...');
    if (!txt) return;
    try{
      const arr = JSON.parse(txt);
      if (!Array.isArray(arr)) throw new Error('Precisa ser um array');
      localStorage.setItem('reels_manual', JSON.stringify(arr));
      renderReels(arr);
      document.getElementById('reelsEmpty').textContent = '(dados manuais)';
      alert('Reels carregados localmente.');
    }catch(e){ alert('JSON inv√°lido: ' + e.message); }
  };

  // KPIs (opcional ‚Äî se /api/stats n√£o existir, escondo)
  async function loadStats(){
    try{
      const r = await fetch('/api/stats'); // se n√£o existir, vai 404
      if (!r.ok) throw new Error('no');
      const j = await r.json();
      document.getElementById('kpiLeads').textContent = j.leads ?? '‚Äî';
      document.getElementById('kpiSales').textContent = j.sales ?? '‚Äî';
      document.getElementById('kpiRev').textContent = j.revenue ?? '‚Äî';
      document.getElementById('kpiConv').textContent = j.conversion ?? '‚Äî';
      document.getElementById('kpiCtr').textContent = j.ctr ?? '‚Äî';
      document.getElementById('kpiRoi').textContent = j.roi ?? '‚Äî';
      document.getElementById('kpi').style.display = '';
    }catch{
      document.getElementById('kpi').style.display = 'none';
    }
  }

  // init
  loadAuth(); loadReels(); loadStats();
})();
</script>
</body>
</html>
