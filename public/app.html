<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>RastroO ‚Äî App</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#111933;--card:#0f152b;--text:#e5e7eb;--muted:#9aa3b2;--border:#1f2942;
      --brand:#7c3aed;--ok:#22c55e;--danger:#ef4444;--warn:#f59e0b;
    }
    [data-theme="light"]{
      --bg:#f7f7fb;--panel:#ffffff;--card:#ffffff;--text:#0f172a;--muted:#6b7280;--border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    a{color:inherit;text-decoration:none}
    .app{min-height:100dvh;display:flex}
    /* Desktop: sidebar; Mobile: some e entra tab bar */
    .sidebar{width:260px;flex:0 0 260px;background:var(--panel);border-right:1px solid var(--border);padding:16px;position:sticky;top:0;height:100dvh;overflow:auto}
    .brand{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .brand-badge{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--brand),#3b82f6);display:grid;place-items:center;font-weight:900}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{padding:10px 12px;border-radius:10px}
    .nav a.active{background:var(--card);border:1px solid var(--border)}
    .main{flex:1;min-width:0;display:flex;flex-direction:column}
    .topbar{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;gap:10px;align-items:center;z-index:10}
    .container{padding:14px;display:grid;gap:14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .btn,select,input,button{font:inherit;color:inherit;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .btn{cursor:pointer}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--card)}
    .tag.paid{background:#22c55e22;color:#22c55e}
    .tag.fail{background:#ef444422;color:#f87171}
    .tag.lead{background:#f59e0b22;color:#fbbf24}
    .muted{color:var(--muted)}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:640px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap;text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .metric .k{font-size:clamp(22px,5vw,30px);font-weight:800}
    .grow{flex:1}
    /* Tab bar (mobile) */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:1px solid var(--border);
      display:none;gap:6px;justify-content:space-around;padding:6px max(8px,env(safe-area-inset-left)) calc(6px + env(safe-area-inset-bottom)) max(8px,env(safe-area-inset-right));z-index:50
    }
    .tabbar a{flex:1;text-align:center;border-radius:10px;padding:8px 6px;display:flex;flex-direction:column;gap:4px;align-items:center;min-height:56px}
    .tabbar a.active{background:var(--card);border:1px solid var(--border)}
    .tabbar .ico{font-size:18px;line-height:1}
    .tabbar .lbl{font-size:12px}
    /* Mobile first */
    @media (max-width:900px){
      .sidebar{display:none}
      .tabbar{display:flex}
      .container{padding-bottom:calc(70px + env(safe-area-inset-bottom))}
      table{min-width:560px}
      .metrics{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar (esconde no mobile) -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="brand-badge">R</div>
        <div><strong>RastroO</strong><div class="muted" style="font-size:12px">Rastreador org√¢nico</div></div>
      </div>
      <nav class="nav">
        <a href="#/dashboard" data-route="dashboard" class="active">üìä Dashboard</a>
        <a href="#/leads" data-route="leads">üë• Leads</a>
        <a href="#/reels" data-route="reels">üé¨ Reels & Insights</a>
        <a href="#/connect" data-route="connect">üîå Conectar Instagram</a>
        <a href="#/settings" data-route="settings">‚öôÔ∏è Configura√ß√µes</a>
      </nav>
    </aside>

    <!-- Conte√∫do -->
    <main class="main">
      <div class="topbar">
        <button class="btn" id="themeBtn">üåì</button>
        <div class="grow"></div>
        <span id="connBadge" class="tag fail">IG: desconectado</span>
      </div>

      <div class="container">
        <!-- Banner de conex√£o (s√≥ aparece se n√£o tiver conectado) -->
        <div class="card" id="connectBanner" style="display:none; background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;border:0">
          <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
            <div><strong>Conecte seu Instagram</strong><div style="opacity:.9">Para ver Reels & insights e atribui√ß√£o.</div></div>
            <a class="btn" style="background:#fff;color:#111" href="/public/connect.html">Conectar</a>
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="v-dashboard">
          <div class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <strong>Vis√£o geral</strong>
            <div class="grow"></div>
            <select id="period">
              <option value="today">Hoje</option>
              <option value="7d" selected>7 dias</option>
              <option value="15d">15 dias</option>
              <option value="30d">30 dias</option>
              <option value="custom">Personalizado‚Ä¶</option>
            </select>
            <span id="customBox" style="display:none;gap:6px;align-items:center">
              <input type="date" id="from"><input type="date" id="to">
              <button class="btn" id="apply">Aplicar</button>
            </span>
          </div>

          <div class="metrics">
            <div class="card metric"><div class="muted">Leads</div><div class="k" id="mLeads">0</div></div>
            <div class="card metric"><div class="muted">Vendas</div><div class="k" id="mSales">0</div></div>
            <div class="card metric"><div class="muted">Receita</div><div class="k" id="mRev">R$ 0,00</div></div>
          </div>

          <div class="card">
            <div class="table-wrap">
              <table>
                <thead><tr><th>Username</th><th>Leads</th><th>Vendas</th><th>Receita</th><th>√öltimo</th><th>Status</th></tr></thead>
                <tbody id="tblUsers"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- LEADS -->
        <section id="v-leads" style="display:none">
          <div class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <strong>Leads (por usu√°rio)</strong>
            <div class="grow"></div>
            <select id="periodL">
              <option value="today">Hoje</option>
              <option value="7d" selected>7 dias</option>
              <option value="15d">15 dias</option>
              <option value="30d">30 dias</option>
              <option value="custom">Personalizado‚Ä¶</option>
            </select>
            <span id="customBoxL" style="display:none;gap:6px;align-items:center">
              <input type="date" id="fromL"><input type="date" id="toL">
              <button class="btn" id="applyL">Aplicar</button>
            </span>
          </div>
          <div class="card">
            <div class="table-wrap">
              <table>
                <thead><tr><th>Username</th><th>Leads</th><th>Vendas</th><th>Receita</th><th>√öltimo</th><th>Status</th></tr></thead>
                <tbody id="tblLeads"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- REELS -->
        <section id="v-reels" style="display:none">
          <div class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <strong>Reels & Insights</strong>
            <div class="grow"></div>
            <a class="btn" href="/public/connect.html">Gerenciar conex√£o</a>
          </div>
          <div class="card">
            <div class="table-wrap">
              <table>
                <thead><tr><th>Reel</th><th>Plays</th><th>Likes</th><th>Coment√°rios</th><th>Leads</th><th>Vendas</th></tr></thead>
                <tbody id="tblReels"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CONNECT -->
        <section id="v-connect" style="display:none">
          <div class="card">
            <strong>Conectar Instagram</strong>
            <p class="muted">Conecte ou reautorize sua conta.</p>
            <a class="btn" href="/public/connect.html">Conectar / Reautorizar</a>
            <a class="btn" href="/api/ig/creds" target="_blank">Status t√©cnico</a>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="v-settings" style="display:none">
          <div class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <strong>Configura√ß√µes</strong>
            <div class="grow"></div>
            <button class="btn" id="themeBtn2">Alternar tema</button>
          </div>
          <div class="card"><span class="muted">Tema e atalhos.</span></div>
        </section>
      </div>
    </main>
  </div>

  <!-- Tab bar (s√≥ no mobile) -->
  <nav class="tabbar">
    <a href="#/dashboard" data-route="dashboard" class="active"><div class="ico">üìä</div><div class="lbl">Dashboard</div></a>
    <a href="#/leads" data-route="leads"><div class="ico">üë•</div><div class="lbl">Leads</div></a>
    <a href="#/reels" data-route="reels"><div class="ico">üé¨</div><div class="lbl">Reels</div></a>
    <a href="#/connect" data-route="connect"><div class="ico">üîå</div><div class="lbl">Conectar</div></a>
  </nav>

  <script>
    // ===== Tema
    const root=document.documentElement;
    const setTheme=t=>{ root.setAttribute('data-theme',t); localStorage.setItem('rastroo_theme',t); };
    setTheme(localStorage.getItem('rastroo_theme')||'dark');
    document.getElementById('themeBtn').onclick=()=>setTheme(root.getAttribute('data-theme')==='light'?'dark':'light');
    document.getElementById('themeBtn2')?.addEventListener('click',()=>setTheme(root.getAttribute('data-theme')==='light'?'dark':'light'));

    // ===== Navega√ß√£o simples (hash)
    const views={
      dashboard: document.getElementById('v-dashboard'),
      leads: document.getElementById('v-leads'),
      reels: document.getElementById('v-reels'),
      connect: document.getElementById('v-connect'),
      settings: document.getElementById('v-settings')
    };
    function show(route){
      Object.values(views).forEach(el=> el.style.display='none');
      (views[route]||views.dashboard).style.display='block';
      document.querySelectorAll('[data-route]').forEach(a=> a.classList.toggle('active', a.getAttribute('data-route')===route));
      if(route==='dashboard') loadSummary();
      if(route==='leads') loadLeads();
      if(route==='reels') loadReels();
      if(route==='connect') updateConn();
    }
    function nav(){ const r=(location.hash.replace('#/','')||'dashboard'); show(r); }
    window.addEventListener('hashchange', nav);

    // ===== Util
    function money(v){ return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
    const tag = s => s==='pago' ? '<span class="tag paid">pago</span>' : (s==='reprovado' ? '<span class="tag fail">reprovado</span>' : '<span class="tag lead">lead</span>');

    // ===== Conex√£o IG (se /api/ig/creds existir)
    const connBadge=document.getElementById('connBadge');
    const connectBanner=document.getElementById('connectBanner');
    async function updateConn(){
      try{
        const r=await fetch('/api/ig/creds'); const j=await r.json();
        const ok=!!(j.connected || j.igid || (j.ok && j.username));
        connBadge.textContent = ok ? 'IG: conectado' : 'IG: desconectado';
        connBadge.className = 'tag ' + (ok ? 'paid':'fail');
        connectBanner.style.display = ok ? 'none' : 'block';
      }catch(_){
        // se o endpoint n√£o existir, s√≥ some o banner para n√£o encher
        connectBanner.style.display = 'none';
        connBadge.textContent = 'IG';
        connBadge.className = 'tag';
      }
    }

    // ===== Per√≠odos
    function rangeVal(selId, boxId, fromId, toId, applyId, onChange){
      const sel=document.getElementById(selId), box=document.getElementById(boxId);
      const from=document.getElementById(fromId), to=document.getElementById(toId), apply=document.getElementById(applyId);
      function doChange(){
        if(sel.value==='custom'){ onChange({custom:true, from:from.value, to:to.value}); }
        else { onChange({range:sel.value}); }
      }
      sel.onchange=()=>{ const c=sel.value==='custom'; box.style.display=c?'inline-flex':'none'; if(!c) doChange(); };
      apply?.addEventListener('click', doChange);
      doChange();
    }
    function isoDate(d){ return d.toISOString().slice(0,10); }
    function datesOf(range){
      if(!range || range==='all') return {};
      if(range==='today'){ const s=isoDate(new Date()); return {from:s,to:s}; }
      const n=parseInt(range); if(!isNaN(n)){
        const end=new Date(); const start=new Date(Date.now()-(n-1)*86400000);
        return {from:isoDate(start), to:isoDate(end)};
      }
      // custom: "YYYY-MM-DD"
      const [from,to]=range.split(','); return {from,to};
    }
    // ===== DASHBOARD (usa /api/report e /api/leads)
    const mLeads=document.getElementById('mLeads'), mSales=document.getElementById('mSales'), mRev=document.getElementById('mRev'), tblUsers=document.getElementById('tblUsers');
    let dashRange='7d';
    rangeVal('period','customBox','from','to','apply',(p)=>{ dashRange = p.custom? `custom:${p.from},${p.to}` : (p.range||'7d'); loadSummary(); });

    async function loadSummary(){
      updateConn();
      // resumo
      try{
        const {from,to}=dashRange.startsWith('custom:') ? (()=>{const s=dashRange.split(':')[1]; const [a,b]=s.split(','); return {from:a,to:b};})() : datesOf(dashRange);
        const qs=new URLSearchParams({ ...(from?{from}:{}) , ...(to?{to}:{}) }).toString();
        const r=await fetch('/api/report?'+qs); const j=await r.json();
        mLeads.textContent = j?.summary?.leads ?? 0;
        mSales.textContent = j?.summary?.sales ?? 0;
        mRev.textContent   = money(j?.summary?.revenue ?? 0);

        // tabela por @username (a partir de /api/leads)
        const r2=await fetch('/api/leads?'+qs); const k=await r2.json();
        const items=(k?.items||[]).slice(0,200);
        tblUsers.innerHTML = items.map(o=>`
          <tr>
            <td>@${o.iu||'-'}</td>
            <td>${o.leads||0}</td>
            <td>${o.sales||0}</td>
            <td>${money(o.revenue||0)}</td>
            <td>${o.last_ts ? new Date(o.last_ts).toLocaleString('pt-BR') : '-'}</td>
            <td>${o.status ? (o.status==='pago' ? '<span class="tag paid">pago</span>' : (o.status==='reprovado' ? '<span class="tag fail">reprovado</span>' : '<span class="tag lead">lead</span>')) : '<span class="tag lead">lead</span>'}</td>
          </tr>
        `).join('') || `<tr><td colspan="6" class="muted">Sem dados.</td></tr>`;
      }catch(_){
        mLeads.textContent=0; mSales.textContent=0; mRev.textContent='R$ 0,00';
        tblUsers.innerHTML = `<tr><td colspan="6" class="muted">Sem dados.</td></tr>`;
      }
    }

    // ===== LEADS (lista igual ao dashboard, s√≥ que inteira)
    let leadsRange='7d';
    const tblLeads=document.getElementById('tblLeads');
    rangeVal('periodL','customBoxL','fromL','toL','applyL',(p)=>{ leadsRange = p.custom? `custom:${p.from},${p.to}` : (p.range||'7d'); loadLeads(); });

    async function loadLeads(){
      try{
        const {from,to}=leadsRange.startsWith('custom:') ? (()=>{const s=leadsRange.split(':')[1]; const [a,b]=s.split(','); return {from:a,to:b};})() : datesOf(leadsRange);
        const qs=new URLSearchParams({ ...(from?{from}:{}) , ...(to?{to}:{}) }).toString();
        const r=await fetch('/api/leads?'+qs); const j=await r.json();
        const items=(j?.items||[]).slice(0,500);
        tblLeads.innerHTML = items.map(o=>`
          <tr>
            <td>@${o.iu||'-'}</td>
            <td>${o.leads||0}</td>
            <td>${o.sales||0}</td>
            <td>${money(o.revenue||0)}</td>
            <td>${o.last_ts ? new Date(o.last_ts).toLocaleString('pt-BR') : '-'}</td>
            <td>${o.status ? (o.status==='pago' ? '<span class="tag paid">pago</span>' : (o.status==='reprovado' ? '<span class="tag fail">reprovado</span>' : '<span class="tag lead">lead</span>')) : '<span class="tag lead">lead</span>'}</td>
          </tr>
        `).join('') || `<tr><td colspan="6" class="muted">Sem dados.</td></tr>`;
      }catch(_){
        tblLeads.innerHTML = `<tr><td colspan="6" class="muted">Erro ao carregar.</td></tr>`;
      }
    }

    // ===== REELS (usa /api/ig/reels)
    const tblReels=document.getElementById('tblReels');
    async function loadReels(){
      updateConn();
      try{
        const r=await fetch('/api/ig/reels'); const j=await r.json();
        const items=j.items || j || [];
        tblReels.innerHTML = items.map(o=>`
          <tr>
            <td><a href="${o.permalink||'#'}" target="_blank">${o.caption?.slice(0,50)||o.id}</a></td>
            <td>${o.insights?.plays ?? o.views ?? 0}</td>
            <td>${o.like_count ?? o.likes ?? 0}</td>
            <td>${o.comments_count ?? o.comments ?? 0}</td>
            <td>${o.counts?.leads ?? o.leads ?? 0}</td>
            <td>${o.counts?.sales ?? o.sales ?? 0}</td>
          </tr>
        `).join('') || `<tr><td colspan="6" class="muted">Conecte o Instagram para ver os Reels.</td></tr>`;
      }catch(_){
        tblReels.innerHTML = `<tr><td colspan="6" class="muted">Erro ao carregar Reels.</td></tr>`;
      }
    }

    // start
    (function start(){
      // tema salvo + conex√£o
      updateConn();
      // rota inicial
      const r=(location.hash.replace('#/','')||'dashboard'); show(r);
      // quando voltar p/ dashboard, recarrega
      document.addEventListener('visibilitychange', ()=>{ if(!document.hidden && location.hash==="#/dashboard") loadSummary(); });
    })();
  </script>
</body>
</html>
